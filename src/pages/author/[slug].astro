---
// src/pages/author/[slug].astro
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import { getSupabaseClient } from '../../lib/supabaseClient';
import CCard from "../../components/cards/CCard.tsx";
import { formatDate } from "../../methods/formatting";
import "../../components/misc/SearchClient.css";

const supabase = getSupabaseClient();
// get slug from URL
const { slug } = Astro.params;

const { data: author, error: authorError } = await supabase
  .from('authors')
  .select('*')
  .eq('slug', slug)
  .single();

if (authorError || !author) {
  throw new Error('Author not found');
}

const { data: articles, error: articlesError } = await supabase
  .from("article_authors")
  .select(`articles (*)`)
  .eq("author_id", author.id)
  .order("date_published", { referencedTable: "articles", ascending: false });
  
if (articlesError) {
  throw articlesError;
}
---

<BaseLayout
  title={`${author.name} - The Cheese Grater Magazine`}
>
  <section class="search-page">
    <h1>{`All articles by ${author.name}: ${articles?.length ?? 0} articles`}</h1>

    <ul class="card-grid">
      {articles?.map(({ articles: article }) => (
        <li>
          <CCard
            slug={article.slug}
            section={article.section}
            title={article.title}
            image={article.image_url ?? article.author_thumbnail!}
            tag={article.subsection}
            date={formatDate(article.date_published)}
            category="subpage"
          />
        </li>
      ))}
    </ul>
  </section>
</BaseLayout>
