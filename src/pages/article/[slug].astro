---
// src/pages/article/[slug].astro
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleContent from '../../components/article/ArticleContent.astro';
import { getSupabaseClient } from '../../lib/supabaseClient';

export async function getStaticPaths() {
  const supabase = getSupabaseClient();

  const { data: articles, error } = await supabase
    .from('articles')
    .select('slug');

  if (error || !articles) {
    return [];
  }

  return articles.map((article) => ({
    params: { slug: article.slug },
  }));
}

const supabase = getSupabaseClient();
// get slug from URL
const { slug } = Astro.params;

// fetch article at request/build time
const { data: article, error } = await supabase
  .from('articles')
  .select('*')
  .eq('slug', slug)
  .single();

if (error || !article) {
  throw new Error('Article not found');
}
---

<BaseLayout
  title=`${article.title} - The Cheese Grater Magazine`
  description={article.summary}
>
  <ArticleContent article={article} isEditor={false} />
</BaseLayout>
