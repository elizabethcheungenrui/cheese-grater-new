---
// src/pages/article/[slug].astro
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleContent from '../../components/article/ArticleContent.astro';
import { getSupabaseClient } from '../../lib/supabaseClient';

const supabase = getSupabaseClient();
// get slug from URL
const { slug } = Astro.params;

// fetch article at request/build time
const { data: article, error } = await supabase
  .from('articles')
  .select('*')
  .eq('slug', slug)
  .single();

if (error || !article) {
  throw new Error('Article not found');
}

const canonicalUrl = `https://cheesegratermagazine.org/article/${article.slug}/`;

function stripHtml(html: string) {
  return html.replace(/<[^>]*>/g, "").trim();
}
---

<BaseLayout
  title=`${article.title} - The Cheese Grater Magazine`
  description={article.summary}
>
  <Fragment slot="head">
    <meta property="og:type" content="article" />
    <meta property="og:title" content={article.title} />
    <meta property="og:description" content={stripHtml(article.summary)} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={article.image_url} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={article.title} />
    <meta name="twitter:description" content={stripHtml(article.summary)} />
    <meta name="twitter:image" content={article.image_url} />

    <script is:inline type="application/ld+json" set:html=
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        "@id": canonicalUrl,
        "headline": article.title,
        "description": article.summary,
        "datePublished": article.date_published,
        "author": {
          "@type": "Person",
          "name": article.author,
        },
        "publisher": {
          "@type": "Organization",
          "name": "The Cheese Grater",
          "logo": {
            "@type": "ImageObject",
            "url": "https://images.cheesegratermagazine.org/logos/cg_cropped.jpeg",
          },
        },
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": canonicalUrl,
        },
        ...(article.image_url && {
          image: [article.image_url],
        }),
      })}
    />
      
    <link rel="canonical" href={canonicalUrl} />
  </Fragment>

  <ArticleContent article={article} isEditor={false} />
</BaseLayout>
