---
import './ArticleContent.css';
import { formatDate } from '../../methods/formatting';
import CCard from '../cards/CCard';
import MBCard from '../cards/MBCard';
import { getSupabaseClient } from '../../lib/supabaseClient';
import { getSubsectionArticles } from '../../lib/getSectionArticles';

const { article, isEditor } = Astro.props;

// fetch related articles at build/request time
const data = await getSubsectionArticles(article.section,article.subsection);

const filtered = data.articles.filter((a) => a.slug !== article.slug);
const dataTop = filtered.slice(0, 4);
const dataBottom = filtered.slice(4, 8);

const supabase = getSupabaseClient();

const { data: authorLinks } = await supabase
  .from("article_authors")
  .select(`
    authors (
      id,
      name,
      slug
    )
  `)
  .eq("article_id", article.id);
---

<article class="article-container">
  <div class="container-main">
    <main class="main-article">
      <header class="main-heading">
        <p class="date">
          <a href={`/${article.section.toLowerCase()}`} class="section-link">
            {article.subsection}
          </a>
          {' / '}
          {formatDate(article.date_published)}
        </p>

        <h1>{article.title}</h1>
      </header>

      <section class="main-content">
        {article.summary && (
          <h2
            set:html={article.summary}
          />)}

        <address class="author-box">
          <img
            class="author-image"
            src={article.author_thumbnail ??
              'https://images.cheesegratermagazine.org/author_thumbnails/cg_author.jpeg'}
            alt={article.author}
            loading="lazy"
          />

          <div class="author-text">
            <span class="author">
              {authorLinks?.length
                ? authorLinks.map(({ authors: author }, i) => {
                  const total = authorLinks.length;

                  return (
                    <>
                      <a href={`/author/${author.slug}`}>{author.name}</a>
                      {total > 1 && i < total - 2 && ', '}
                      {total > 1 && i === total - 2 && '& '}
                    </>
                    )})
                : article.author
              }
            </span>
            <span class="role">{article.role}</span>
          </div>
        </address>

        {
          article.image_url && (
            <img src={article.image_url} alt={article.image_caption || ''} />
          )
        }

        {
          article.image_caption && (
            <p class="caption">{article.image_caption}</p>
          )
        }

        {
          article.content && (
            <div class="article-body" set:html={article.content} />
          )
        }
      </section>
    </main>

    {
      !isEditor && (
        <aside class="more-article">
          <span class="readmore">
            {article.section === 'Podcast' ? 'Listen to more' : 'Read more'}
          </span>

          <div class="article-row desktop-only">
            {dataTop.map((a) => (
              <CCard
                slug={a.slug}
                section={data.section}
                title={a.title}
                image={a.image_url ?? a.author_thumbnail}
                tag={a.subsection}
                date={formatDate(a.date_published)}
                category="subpage"
              />
            ))}
          </div>

          <div class="article-row desktop-only">
            {dataBottom.map((a) => (
              <CCard
                slug={a.slug}
                section={data.section}
                title={a.title}
                image={a.image_url ?? a.author_thumbnail}
                tag={a.subsection}
                date={formatDate(a.date_published)}
                category="subpage"
              />
            ))}
          </div>

          <div class="article-row mobile-only">
            {dataTop.map((a) => (
              <MBCard
                slug={a.slug}
                section={data.section}
                title={a.title}
                image={a.image_url ?? a.author_thumbnail}
                tag={a.subsection}
                date={formatDate(a.date_published)}
                articlecontent={true};
              />
            ))}
          </div>
        </aside>
      )
    }
  </div>

  {
    !isEditor && (
      <aside class="container-side">
        <div class="contact-newsletter">
          <span class="side-header">Got a story for us?</span>
          <p>
            If you have something you want to share with our journalists, send
            us a tip via our
            <a href="https://instagram.com/uclcheesegrater" target="_blank">
              {' '}
              socials
            </a>
            ,<a href="/get-involved"> email</a>, or our
            <a href="/anonymous-form"> anonymous webform</a>.
          </p>
        </div>
      </aside>
    )
    }
</article>
